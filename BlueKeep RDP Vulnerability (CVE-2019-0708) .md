# BlueKeep RDP Vulnerability (CVE-2019-0708)

Friday, March 18, 2022 (By Ibrahim Tamim)

This document covers the BlueKeep RDP Vulnerability (CVE-2019-0708).  It will first introduce Microsoft's Remote Desktop Protocol (RDP) then discuss key technical methods used in the protocol and how they lead to hackers finding a very critical vulnerability in RDP. You can access a PDF of the slides discussing this topic  [here]().

# Remote Desktop Protocol

Owned and developed by Microsoft (MS), RDP is a protocol that allows users to connect to computing machines remotely. It offers an easy-to-use GUI, which is one of the reasons for its massive popularity.

RDP is a multi-channel capable protocol to allow independent and virtual machines exchange information. This information can be serial device communications, licensing information, presentation data, and highly encrypted data, such as keyboard, mouse activity. RDP belongs to the family of MS's T-120 protocols.

The accessing user must run RDP’s client software, while the accessed machine should run RDP’s server software. All MS Windows versions from Windows XP onwards utilize RDP for remote connections.

You can find more details about the protocol [here](https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol).

# Key RDP Features

- Port Redirection allows applications running within the terminal session to access local serial and parallel ports directly.
- Support for Transport Layer Security (TLS)
- RDP is heavily use by organizations for resolving technical issues, debugging computer, and debugging/resolving network related problems.
- Due to the massive reach of the protocol, hackers have been very active in exploiting the software for any availabilities.

# Technical Background

RDP uses TCP over port 3389 by default. This port is used to connect to the remote RDP server. At "connect" time, RDP creates static virtual channels to facilitate the data exchange. By default two channels are created, S_T120 (used by RDP itself) and CTXTW (used in [Citrix ICA](https://www.extrahop.com/resources/protocols/citrix-ica/)).

Channels are created using termdd!IcaCreateChannel(), which first checks whether the specified channel exists. If not, RDP allocates a channel structure to create it. A pointer to the  _ChannelControlStructure_ is stored within a _ChannelPointerTable,_  like this:

![Source: [www.opswat](https://www.opswat.com/)](https://static.opswat.com/uploads/images/50129b4f-06aa-4fe9-8a48-fffc263e2a56.png)

Image by [opswat.](https://www.opswat.com/)

These fundamental RDP functions suffer from a major vulnerability called **Use-After-Free (UAF)**. It's the core exploit behind BlueKeep. The following sections will first introduce **UAF** then detail the BlueKeep vulnerability.

# Use-After-Free (UAF) Vulnerability

**UAF** is a vulnerability caused by the incorrect use of dynamic memory (e.g. heap) at execution time. UAF occurs when a memory location is marked as "free" but the executing code does not clear the pointer to that memory location. Attackers can exploit this incident to hack into the heap and retrieve critical information to inflict damage or penetrate a machine or network.

Potential consequences of UAF exploitation include:

-  Data corruption,

-  Program crashes,

-  Arbitrary code execution.

# BlueKeep RDP Vulnerability

BlueKeep is a vulnerability that allows unauthenticated attackers to connect to a target system using MS RDP. Once connected, attackers can send malicious requests to inject worms or gain admin code execution privileges on the target machines.

**BlueKeep is considered a "Critical and Wormable Remote Code Execution Vulnerability"**

*A wormable vulnerability is a vulnerability that it does not require human interaction to spread its attack surface to another vulnerable Windows server.*

BlueKeep has a Common Vulnerability Scoring System (CVSS) score of 10. You can view BlueKeep's Common Vulnerabilities and Exposures (CVE) Database Entry [here](https://www.cvedetails.com/cve-details.php?t=1&cve_id=CVE-2019-0708+)

"In May 2019, Microsoft released an out-of-band patch update for remote code execution (RCE) vulnerability CVE-2019-0708, which is also known as “BlueKeep” and resides in code for Remote Desktop Services (RDS). Over the last year, researchers had proved the exploitability of BlueKeep and proposed countermeasures to detect and prevent it. However, RDP is still one of the most popular attack vectors used by attackers today. To make it harder for RDP attacks to succeed and to better protect Windows users and our customers, we will disclose detailed information in this blog about how attackers might exploit BlueKeep on Windows RDP endpoints. In August 2019, Unit 42 researchers published a blog on [CVE-2019-0708](https://unit42.paloaltonetworks.com/exploitation-of-windows-cve-2019-0708-bluekeep-three-ways-to-write-data-into-the-kernel-with-rdp-pdu/), covering how Bitmap Cache protocol data unit (PDU), Refresh Rect PDU and RDPDR Client Name Request PDU can be used to write data into the Windows kernel memory. Additionally, in October 2019, Unit 42 researchers [presented](https://unit42.paloaltonetworks.com/unit-42-presents-new-research-at-bluehat-seattle-on-three-new-windows-rdp-vulnerability-exploit-methods/) three new Windows kernel pool Feng Shui techniques with RDP PDUs and two different exploit techniques of BlueKeep at Microsoft’s BlueHat Seattle 2019 Security Conference." [By [Tao Yan](https://unit42.paloaltonetworks.com/author/tao-yan/ "Posts by Tao Yan") and [Jin Chen](https://unit42.paloaltonetworks.com/author/jin-chen/ "Posts by Jin Chen")]

# A Technical Look at BlueKeep

As in the background section, BlueKeep is based on the UAF vulnerability. In addition to the default MS_T120 channel, the RDP client can create customized channels. With this capabilities, the attacker first creates a custom channel also name "MS_T120". This is done by adding the custom channel to the channelDefArray (shown below).

![Source: [](.)](https://unit42.paloaltonetworks.com/wp-content/uploads/2020/12/word-image.png)

Image by [Tao Yan](https://unit42.paloaltonetworks.com/author/tao-yan/ "Posts by Tao Yan") and [Jin Chen](https://unit42.paloaltonetworks.com/author/jin-chen/ "Posts by Jin Chen")

Once the request for a new channel is received, the RDP server creates a reference for the new object in ChannelPointerTable. Shown below are the two MS_T120 created by the RDP default connect request and then by the attacker.

![Source: [](.)](https://unit42.paloaltonetworks.com/wp-content/uploads/2020/12/word-image-1.png)

Images by [Tao Yan](https://unit42.paloaltonetworks.com/author/tao-yan/ "Posts by Tao Yan") and [Jin Chen](https://unit42.paloaltonetworks.com/author/jin-chen/ "Posts by Jin Chen")

The attacker now joins the customized MS_T120 channel and the channel can now be opened by the RDP client. The attacker now crafts and send in data to the MS_T120 channel (shown below). This calls the MCSPortData function in rdpwx.dll.

![Source: [](.)](https://unit42.paloaltonetworks.com/wp-content/uploads/2020/12/word-image-2.png)

Images by [Tao Yan](https://unit42.paloaltonetworks.com/author/tao-yan/ "Posts by Tao Yan") and [Jin Chen](https://unit42.paloaltonetworks.com/author/jin-chen/ "Posts by Jin Chen")

The MCSPortData method is designed where the data starting from 0x754 offset of the initial argument lpAddend is all controlled by the RDP client. We notice that when the attribute “v2” is equal to the value “2” (which the precious message sent by the attacker was designed to do), the method MCSChannelClose will be executed to free the MS_T120  channel as shown below.

![Source: [](.)](https://unit42.paloaltonetworks.com/wp-content/uploads/2020/12/word-image-3.png)

Images by [Tao Yan](https://unit42.paloaltonetworks.com/author/tao-yan/ "Posts by Tao Yan") and [Jin Chen](https://unit42.paloaltonetworks.com/author/jin-chen/ "Posts by Jin Chen")

Finally, and after MS_T120 is freed, there will remain a dangling pointer left pointing to the freed MS_T120 channel object. The RDP now disconnects, calling the function RDPWD!SignalBrokenConnection followed by termdd!IcaChannelInput and this will result in accessing the freed MS_T120 object.

The attack still requires many technical steps. You can find all the details  [here](https://unit42.paloaltonetworks.com/cve-2019-0708-bluekeep/).
# Mitigations Before The Patch
- Disable Remote Desktop Services if they are not required.
- Enable Network Level Authentication (NLA) on systems running supported editions of Windows.
- Block TCP port 3389 at the enterprise perimeter firewall.
- Microsoft issued a security patch (including an out-of-band update for several versions of Windows that have reached their end-of-life, such as Windows XP) on 14 May 2019.

# Additional Resources and Research Papers

- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2019-0708
- https://www.cisa.gov/uscert/ncas/alerts/AA19-168A
- [How to Exploit the BlueKeep Vulnerability with Metasploit](https://pentest-tools.com/blog/bluekeep-exploit-metasploit)
- https://www.welivesecurity.com/2019/12/17/bluekeep-time-disconnect-rdp-internet/
- https://www.opswat.com/blog/bluekeep-detecting-and-remediating-a-critical-and-wormable-remote-code-execution-vulnerability
- [Use-After-Free (UAF)](https://encyclopedia.kaspersky.com/glossary/use-after-free/)
